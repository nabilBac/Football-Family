<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Test API Events - FootballFamily</title>
  <style>
    body { font-family: Inter, Roboto, Arial; margin: 20px; max-width: 980px; }
    h1 { color: #3b3b98; }
    label { display:block; margin-top:10px; font-weight:600; }
    input[type="text"], input[type="number"], input[type="date"], button { width: 100%; max-width: 320px; padding:6px; margin-top:6px; box-sizing: border-box; }
    button { margin-top:10px; padding:8px 12px; border-radius:6px; cursor:pointer; }
    .row { display:flex; gap:16px; align-items:flex-end; margin-top:12px; flex-wrap: wrap; }
    .box { background:#f7f7fb; border:1px solid #e1e1ee; padding:12px; border-radius:8px; margin-top:12px; margin-bottom:20px; }
    pre { white-space:pre-wrap; word-wrap:break-word; background:#fff; padding:10px; border-radius:6px; border:1px solid #eee; overflow-x:auto; }
    .success { color: #0a8a3b; background-color: #e0f8e9; padding: 6px; border-radius: 4px; }
    .error { color: #b71c1c; background-color: #fbe0e0; padding: 6px; border-radius: 4px; }

    @media (max-width: 600px) {
      body { margin: 10px; }
      .row { flex-direction: column; gap: 10px; }
      input[type="text"], input[type="number"], input[type="date"], button { max-width: 100%; }
    }
  </style>
</head>
<body>
  <h1>Test API Events ‚Äî FootballFamily</h1>
  <p>Tester tous les endpoints <code>/api/events</code> (CRUD, inscription, match, stats, m√©dia, places).</p>

  <!-- Cr√©er un √©v√©nement -->
  <div class="box">
    <h3>Cr√©er un √©v√©nement</h3>
    <label>Nom</label>
    <input id="create_name" type="text" placeholder="Ex: Tournoi U11" />
    <label>Type</label>
    <input id="create_type" type="text" placeholder="Ex: tournoi, match, comp√©tition" />
    <label>Date</label>
    <input id="create_date" type="date" />
    <label>Lieu</label>
    <input id="create_location" type="text" placeholder="Ex: Stade municipal" />
    <div class="row">
      <button onclick="createNewEvent()">Cr√©er l'√©v√©nement</button>
      <button onclick="clearCreate()">R√©initialiser</button>
    </div>
    <div id="create_result"></div>
  </div>

  <!-- Ajouter √©quipe √† un √©v√©nement -->
  <div class="box">
    <h3>Ajouter une √©quipe √† un √©v√©nement</h3>
    <label>Event Id</label>
    <input id="add_eventId" type="number" min="1" />
    <label>Team Id</label>
    <input id="add_teamId" type="number" min="1" />
    <div class="row">
      <button onclick="addTeam()">Ajouter l'√©quipe</button>
      <button onclick="clearAdd()">R√©initialiser</button>
    </div>
    <div id="add_result"></div>
  </div>

  <!-- Cr√©er un match -->
  <div class="box">
    <h3>Cr√©er un match pour un √©v√©nement</h3>
    <label>Event Id</label>
    <input id="match_eventId" type="number" min="1" />
    <label>Nom du match</label>
    <input id="match_name" type="text" />
    <label>Date</label>
    <input id="match_date" type="date" />
    <label>Lieu</label>
    <input id="match_location" type="text" />
    <label>Team Ids (comma separated)</label>
    <input id="match_teamIds" type="text" placeholder="Ex: 1,2" />
    <div class="row">
      <button onclick="createMatch()">Cr√©er le match</button>
      <button onclick="clearMatch()">R√©initialiser</button>
    </div>
    <div id="match_result"></div>
  </div>

  <!-- Lister √©v√©nements -->
  <div class="box">
    <h3>Lister tous les √©v√©nements</h3>
    <button onclick="getAllEvents()">Lister</button>
    <div id="list_result"></div>
  </div>

  <!-- S'inscrire √† un √©v√©nement -->
  <div class="box">
    <h3>S'inscrire √† un √©v√©nement</h3>
    <label>Event Id</label>
    <input id="reg_eventId" type="number" />
    <label>Player Id</label>
    <input id="reg_playerId" type="number" />
    <div class="row">
      <button onclick="registerPlayer()">S'inscrire</button>
      <button onclick="clearRegister()">R√©initialiser</button>
    </div>
    <div id="register_result"></div>
  </div>

  <!-- Lister inscriptions -->
  <div class="box">
    <h3>Lister les inscriptions d'un √©v√©nement</h3>
    <input id="list_reg_eventId" type="number" />
    <button onclick="getRegistrations()">Lister</button>
    <div id="list_reg_result"></div>
  </div>

  <!-- Valider inscription -->
  <div class="box">
    <h3>Valider une inscription</h3>
    <label>Event Id</label>
    <input id="validate_eventId" type="number" />
    <label>Registration Id</label>
    <input id="validate_registrationId" type="number" />
    <div class="row">
      <button onclick="validateRegistration()">Valider</button>
      <button onclick="clearValidate()">R√©initialiser</button>
    </div>
    <div id="validate_result"></div>
  </div>

  <!-- Ajouter un m√©dia -->
  <div class="box">
    <h3>Ajouter un m√©dia √† un √©v√©nement</h3>
    <label>Event Id</label>
    <input id="media_eventId" type="number" />
    <label>URL du m√©dia</label>
    <input id="media_url" type="text" />
    <div class="row">
      <button onclick="addMedia()">Ajouter</button>
      <button onclick="clearMedia()">R√©initialiser</button>
    </div>
    <div id="media_result"></div>
  </div>

  <!-- Voir nombre de places restantes -->
  <div class="box">
    <h3>Nombre de places restantes</h3>
    <label>Event Id</label>
    <input id="places_eventId" type="number" />
    <div class="row">
      <button onclick="getRemainingPlaces()">Voir</button>
    </div>
    <div id="places_result"></div>
  </div>

  <!-- Console -->
  <div class="box">
    <h3>Console / sortie</h3>
    <pre id="output">Aucune action pour l'instant.</pre>
  </div>

<script>
const out = (obj, ok=true) => {
  const el = document.getElementById('output');
  const time = new Date().toLocaleTimeString();
  const title = ok ? `[OK ${time}]` : `[ERR ${time}]`;
  el.textContent = title + " " + (typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2)) + "\n\n" + el.textContent;
};

const showHtml = (id, payload, ok=true) => {
  document.getElementById(id).innerHTML = ok ? '<span class="success">Succ√®s</span>: <pre>' + JSON.stringify(payload, null, 2) + '</pre>' : '<span class="error">Erreur</span>: <pre>' + JSON.stringify(payload, null, 2) + '</pre>';
  out(payload, ok);
};

async function createNewEvent() {
  const name = document.getElementById('create_name').value;
  const type = document.getElementById('create_type').value;
  const date = document.getElementById('create_date').value;
  const location = document.getElementById('create_location').value;
  if(!name || !type || !date || !location) { alert('Remplis tous les champs'); return; }
  try {
    const res = await fetch('/api/events', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, type, date, location })
    });
    const data = await res.json();
    showHtml('create_result', data, res.ok);
  } catch(err) { showHtml('create_result', err, false); }
}

async function addTeam() {
  const eventId = document.getElementById('add_eventId').value;
  const teamId = document.getElementById('add_teamId').value;
  if(!eventId || !teamId) { alert('Remplis eventId et teamId'); return; }
  try {
    const res = await fetch(`/api/events/${eventId}/add-team?teamId=${teamId}`, { method:'POST' });
    const data = await res.json();
    showHtml('add_result', data, res.ok);
  } catch(err) { showHtml('add_result', err, false); }
}

async function createMatch() {
  const eventId = document.getElementById('match_eventId').value;
  const name = document.getElementById('match_name').value;
  const date = document.getElementById('match_date').value;
  const location = document.getElementById('match_location').value;
  const teamIds = document.getElementById('match_teamIds').value.split(',').map(x=>parseInt(x.trim()));
  if(!eventId || !name || !date || !location || !teamIds.length) { alert('Remplis tous les champs'); return; }
  try {
    const res = await fetch(`/api/events/${eventId}/create-match?name=${encodeURIComponent(name)}&date=${encodeURIComponent(date)}&location=${encodeURIComponent(location)}&teamIds=${teamIds.join(',')}`, { method:'POST' });
    const data = await res.json();
    showHtml('match_result', data, res.ok);
  } catch(err) { showHtml('match_result', err, false); }
}

async function getAllEvents() {
  try {
    const res = await fetch('/api/events/all');
    const data = await res.json();
    showHtml('list_result', data, res.ok);
  } catch(err) { showHtml('list_result', err, false); }
}

async function registerPlayer() {
    const eventId = document.getElementById('reg_eventId').value;
    const playerId = document.getElementById('reg_playerId').value;
    if(!eventId || !playerId) { alert('Remplis eventId et playerId'); return; }
    
    try {
        const res = await fetch(`/api/events/${eventId}/register?playerId=${playerId}`, { method:'POST' });
        
        // üí° Logique de gestion du statut de la r√©ponse
        const data = await res.json();
        
        if (res.ok) {
            // Statuts 200, 201, etc.
            showHtml('register_result', data, true);
        } else if (res.status === 409) {
            // ‚úÖ CORRECTION : G√©rer sp√©cifiquement le 409 Conflict
            const errorMessage = `Code 409 Conflict: ${data.message || "Le joueur est d√©j√† inscrit."}`;
            showHtml('register_result', data, false);
            // Afficher l'erreur dans la console pour d√©bogage
            out(errorMessage, false); 
        } else {
            // G√©rer les autres erreurs (400, 404, 500, etc.)
            const errorMessage = `Erreur HTTP ${res.status}: ${data.message || 'Une erreur inconnue est survenue.'}`;
            showHtml('register_result', data, false);
            out(errorMessage, false);
        }
        
    } catch(err) { 
        // Cette erreur est d√©clench√©e si la requ√™te √©choue compl√®tement (r√©seau, JSON malform√©)
        showHtml('register_result', {error: 'Erreur r√©seau ou JSON malform√©', detail: err.toString()}, false); 
    }
}

async function getRegistrations() {
  const eventId = document.getElementById('list_reg_eventId').value;
  if(!eventId) { alert('Pr√©cise eventId'); return; }
  try {
    const res = await fetch(`/api/events/${eventId}/registrations`);
    const data = await res.json();
    showHtml('list_reg_result', data, res.ok);
  } catch(err) { showHtml('list_reg_result', err, false); }
}

async function validateRegistration() {
  const eventId = document.getElementById('validate_eventId').value;
  const registrationId = document.getElementById('validate_registrationId').value;
  if(!eventId || !registrationId) { alert('Remplis eventId et registrationId'); return; }
  try {
    const res = await fetch(`/api/events/${eventId}/registrations/${registrationId}/validate`, { method:'POST' });
    const data = await res.json();
    showHtml('validate_result', data, res.ok);
  } catch(err) { showHtml('validate_result', err, false); }
}

async function addMedia() {
  const eventId = document.getElementById('media_eventId').value;
  const url = document.getElementById('media_url').value;
  if(!eventId || !url) { alert('Remplis eventId et url'); return; }
  try {
    const res = await fetch(`/api/events/${eventId}/media`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({url}) });
    const data = await res.json();
    showHtml('media_result', data, res.ok);
  } catch(err) { showHtml('media_result', err, false); }
}

async function getRemainingPlaces() {
  const eventId = document.getElementById('places_eventId').value;
  if(!eventId) { alert('Pr√©cise eventId'); return; }
  try {
    const res = await fetch(`/api/events/${eventId}/remaining-places`);
    const data = await res.json();
    showHtml('places_result', data, res.ok);
  } catch(err) { showHtml('places_result', err, false); }
}

// Fonctions de reset
function clearCreate(){ document.getElementById('create_name').value=''; document.getElementById('create_type').value=''; document.getElementById('create_date').value=''; document.getElementById('create_location').value=''; document.getElementById('create_result').innerHTML=''; }
function clearAdd(){ document.getElementById('add_eventId').value=''; document.getElementById('add_teamId').value=''; document.getElementById('add_result').innerHTML=''; }
function clearMatch(){ document.getElementById('match_eventId').value=''; document.getElementById('match_name').value=''; document.getElementById('match_date').value=''; document.getElementById('match_location').value=''; document.getElementById('match_teamIds').value=''; document.getElementById('match_result').innerHTML=''; }
function clearRegister(){ document.getElementById('reg_eventId').value=''; document.getElementById('reg_playerId').value=''; document.getElementById('register_result').innerHTML=''; }
function clearValidate(){ document.getElementById('validate_eventId').value=''; document.getElementById('validate_registrationId').value=''; document.getElementById('validate_result').innerHTML=''; }
function clearMedia(){ document.getElementById('media_eventId').value=''; document.getElementById('media_url').value=''; document.getElementById('media_result').innerHTML=''; }
</script>

</body>
</html>
